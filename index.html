<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bienestar Q19 - Studio</title>
    
    <!-- Librerías -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        q19: { 50: '#f0f9fa', 100: '#d5eff1', 500: '#2d8a8e', 700: '#236c6f', 900: '#1a4d4f' },
                        gold: { 400: '#d4af37', 500: '#c5a059', 600: '#a68545' }
                    },
                    fontFamily: {
                        serif: ['Playfair Display', 'serif'],
                        sans: ['Lato', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Lato', sans-serif; background: #fdfdfd; color: #374151; }
        h1, h2, h3, .brand-font { font-family: 'Playfair Display', serif; }
        
        /* Control de Visibilidad Admin */
        .admin-only { display: none !important; }
        .is-admin .admin-only { display: inline-block !important; }
        .is-admin .admin-flex { display: flex !important; }
        
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>

    <!-- ================= AUTH SCREEN ================= -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center p-6 bg-[url('https://images.unsplash.com/photo-1552196563-55cd4e45efb3?q=80&w=1926&auto=format&fit=crop')] bg-cover bg-center relative">
        <div class="absolute inset-0 bg-q19-900/50 backdrop-blur-sm"></div>
        
        <div id="login-card" class="bg-white/95 backdrop-blur-xl p-10 rounded-2xl shadow-2xl w-full max-w-md relative z-10 border-t-4 border-q19-500">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-q19-50 text-q19-700 mb-4 shadow-inner">
                    <span class="brand-font text-3xl font-bold">Q</span>
                </div>
                <h2 class="text-3xl font-bold text-gray-900 brand-font">Bienestar Q19</h2>
                <p class="text-gray-500 mt-2 font-light">Tu espacio de salud en Albacete</p>
            </div>

            <form id="form-login" class="space-y-5">
                <div>
                    <input type="email" id="login-email" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-q19-500 outline-none transition placeholder-gray-400" placeholder="Correo electrónico" required>
                </div>
                <div>
                    <input type="password" id="login-password" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-q19-500 outline-none transition placeholder-gray-400" placeholder="Contraseña" required>
                </div>
                <button type="submit" class="w-full bg-q19-700 text-white py-3.5 rounded-lg font-bold hover:bg-q19-900 transition shadow-lg tracking-wide uppercase text-sm">Iniciar Sesión</button>
            </form>

            <div class="mt-8 text-center">
                <button onclick="toggleAuth('register')" class="text-gray-500 hover:text-q19-700 text-sm font-medium transition">¿Primera vez? Crea tu cuenta aquí</button>
            </div>
            
            <div class="mt-8 pt-6 border-t border-gray-100 flex justify-center">
                <a href="https://www.farmaciaq19fmas.com/" target="_blank" class="flex items-center gap-2 text-xs text-gray-400 hover:text-q19-500 transition group">
                    <i class="ph-bold ph-storefront text-lg group-hover:scale-110 transition"></i>
                    Visita Farmacia Q19
                </a>
            </div>
        </div>

        <div id="register-card" class="bg-white/95 backdrop-blur-xl p-10 rounded-2xl shadow-2xl w-full max-w-md relative z-10 border-t-4 border-gold-500 hidden">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-900 brand-font">Nueva Cuenta</h2>
                <p class="text-gray-500 text-sm">Empieza a cuidar de ti</p>
            </div>
            <form id="form-register" class="space-y-5">
                <input type="email" id="reg-email" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg outline-none" placeholder="Tu email" required>
                <input type="password" id="reg-password" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg outline-none" placeholder="Crea una contraseña" required>
                <button type="submit" class="w-full bg-gray-900 text-white py-3.5 rounded-lg font-bold hover:bg-black transition shadow-lg uppercase text-sm">Crear Cuenta</button>
            </form>
            <div class="mt-6 text-center">
                <button onclick="toggleAuth('login')" class="text-q19-500 font-bold text-sm hover:underline">Volver a Iniciar Sesión</button>
            </div>
        </div>
    </div>

    <!-- ================= APP PRINCIPAL ================= -->
    <div id="app-view" class="hidden min-h-screen flex flex-col bg-gray-50/50">
        <!-- HEADER -->
        <header class="bg-white sticky top-0 z-50 border-b border-gray-100">
            <div class="max-w-6xl mx-auto px-4 h-20 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-q19-700 rounded-full flex items-center justify-center text-white shadow-md">
                        <span class="brand-font font-bold text-xl pb-1">Q</span>
                    </div>
                    <div class="hidden sm:block">
                        <h1 class="brand-font font-bold text-xl text-gray-900 leading-none">Bienestar Q19</h1>
                        <span class="text-[10px] tracking-[0.2em] text-gold-600 uppercase font-bold">Studio & Wellness</span>
                    </div>
                </div>

                <div class="flex items-center gap-8">
                    <!-- CONTADOR DE BONOS -->
                    <div class="flex flex-col items-end">
                        <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-0.5">Saldo Disponible</span>
                        <div class="flex items-center gap-2 text-q19-900 bg-q19-50 px-3 py-1 rounded-full border border-q19-100">
                            <i class="ph-fill ph-ticket text-gold-500 text-lg"></i>
                            <span id="bonos-count" class="font-bold text-lg leading-none">0</span>
                            <span class="text-xs font-medium text-gray-500">clases</span>
                        </div>
                    </div>

                    <div class="h-8 w-px bg-gray-200 hidden sm:block"></div>

                    <button onclick="logout()" class="text-gray-400 hover:text-red-500 transition p-2 hover:bg-red-50 rounded-full" title="Cerrar Sesión">
                        <i class="ph-bold ph-sign-out text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- BARRA DE ADMIN (Solo visible si es admin por CSS) -->
            <div class="admin-only hidden w-full bg-gray-900 text-white text-xs font-medium">
                <div class="max-w-6xl mx-auto flex">
                    <button onclick="switchTab('horarios')" id="tab-horarios" class="px-6 py-3 border-b-2 border-gold-500 hover:bg-gray-800 transition flex items-center gap-2">
                        <i class="ph-bold ph-calendar-check"></i> Gestión Reservas
                    </button>
                    <button onclick="switchTab('usuarios')" id="tab-usuarios" class="px-6 py-3 border-b-2 border-transparent text-gray-400 hover:text-white hover:bg-gray-800 transition flex items-center gap-2">
                        <i class="ph-bold ph-users-three"></i> Usuarios y Bonos
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-grow max-w-6xl mx-auto px-4 py-10 w-full">
            
            <!-- VISTA HORARIOS -->
            <div id="view-horarios" class="fade-in">
                <!-- Banner Bienvenida -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-12 gap-6">
                    <div>
                        <span class="text-gold-600 font-bold tracking-widest text-xs uppercase mb-2 block">Calendario Semanal</span>
                        <h2 class="text-4xl brand-font font-bold text-gray-900">Reserva tu momento</h2>
                        <p class="text-gray-500 mt-3 font-light text-lg max-w-xl">Disfruta de nuestras sesiones de Pilates Reformer y Yoga Vinyasa diseñadas para tu equilibrio.</p>
                    </div>
                    <!-- Botón Admin (Generar) -->
                    <button onclick="generarSemana()" class="admin-only hidden bg-white border border-gray-200 text-indigo-600 px-5 py-2.5 rounded-lg text-sm font-bold shadow-sm hover:shadow-md hover:border-indigo-200 transition flex items-center gap-2">
                        <i class="ph-bold ph-magic-wand"></i> Generar Semana Completa
                    </button>
                </div>

                <!-- Alerta Sin Bonos -->
                <div id="no-bonos-alert" class="hidden mb-10 bg-orange-50 border border-orange-100 p-5 rounded-xl flex flex-col sm:flex-row justify-between items-center gap-4 shadow-sm">
                    <div class="flex items-center gap-4">
                        <div class="bg-orange-100 p-2 rounded-full text-orange-500">
                            <i class="ph-fill ph-warning-circle text-2xl"></i>
                        </div>
                        <div>
                            <p class="font-bold text-orange-900 text-lg">Saldo insuficiente</p>
                            <p class="text-sm text-orange-800/80">Necesitas recargar bonos para reservar clase.</p>
                        </div>
                    </div>
                    <a href="https://maps.google.com/?q=Farmacia+Q19+Albacete" target="_blank" class="text-xs bg-white text-orange-800 px-4 py-2 rounded-lg border border-orange-200 font-bold hover:bg-orange-50 hover:border-orange-300 transition uppercase tracking-wide">
                        Ir a Farmacia Q19
                    </a>
                </div>

                <div id="schedule-container" class="space-y-12"></div>
                
                <div id="empty-state" class="hidden flex flex-col items-center justify-center py-24 text-center">
                    <div class="bg-gray-50 p-6 rounded-full mb-4">
                        <i class="ph-duotone ph-calendar-slash text-4xl text-gray-300"></i>
                    </div>
                    <p class="text-gray-500 text-lg font-light">No hay clases disponibles en este momento.</p>
                    <p class="text-sm text-gray-400 mt-1">Vuelve a consultar pronto.</p>
                </div>
            </div>

            <!-- VISTA USUARIOS (Admin) -->
            <div id="view-usuarios" class="hidden fade-in">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl brand-font font-bold text-gray-900">Cartera de Clientes</h2>
                        <p class="text-gray-500 mt-1">Gestiona recargas y saldos manualmente.</p>
                    </div>
                    <!-- Buscador -->
                    <div class="relative w-full md:w-80">
                        <i class="ph-bold ph-magnifying-glass absolute left-3 top-3.5 text-gray-400"></i>
                        <input type="text" id="user-search" onkeyup="filtrarUsuarios()" 
                            class="w-full pl-10 pr-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-q19-500 outline-none shadow-sm transition" 
                            placeholder="Buscar por email...">
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50/50 border-b border-gray-100 text-xs uppercase text-gray-500 font-bold tracking-wider">
                            <tr>
                                <th class="px-6 py-4">Cliente</th>
                                <th class="px-6 py-4 text-center">Rol</th>
                                <th class="px-6 py-4 text-center">Saldo Actual</th>
                                <th class="px-6 py-4 text-right">Acciones Rápidas</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="divide-y divide-gray-50 text-sm">
                            <!-- JS Inserta filas -->
                        </tbody>
                    </table>
                    <div id="no-users-found" class="hidden p-10 text-center text-gray-400 italic">No se encontraron usuarios con ese email.</div>
                </div>
            </div>

        </main>

        <footer class="bg-white border-t border-gray-200 py-10 mt-auto">
            <div class="max-w-6xl mx-auto px-4 text-center">
                <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center text-gray-400 mx-auto mb-4">
                    <span class="brand-font font-bold text-xl pb-1">Q</span>
                </div>
                <p class="brand-font font-bold text-q19-900 text-lg mb-2">Bienestar Q19</p>
                <p class="text-gray-400 text-sm mb-6 max-w-md mx-auto">Un espacio dedicado a tu salud integral, avalado por Farmacia Q19 Albacete.</p>
                <div class="flex justify-center gap-6 text-2xl text-q19-500">
                    <a href="#" class="hover:text-q19-700 hover:scale-110 transition"><i class="ph-fill ph-instagram-logo"></i></a>
                    <a href="#" class="hover:text-q19-700 hover:scale-110 transition"><i class="ph-fill ph-facebook-logo"></i></a>
                    <a href="#" class="hover:text-q19-700 hover:scale-110 transition"><i class="ph-fill ph-whatsapp-logo"></i></a>
                </div>
                <div class="mt-8 text-xs text-gray-300">
                    &copy; 2025 Bienestar Q19. Todos los derechos reservados.
                </div>
            </div>
        </footer>
    </div>

    <!-- JS LOGIC -->
    <script>
        // --- 1. CONFIG ---
        const SUPA_URL = 'https://jkjifmrrlyncuwpjhxvk.supabase.co';
        const SUPA_KEY = 'sb_publishable_xnIELom1ouXaBDJNYaWDAQ_VJNjlnIK'; 
        const client = window.supabase.createClient(SUPA_URL, SUPA_KEY);

        let currentUser = null;
        let isAdmin = false;
        let userBonos = 0;
        let allUsersCache = [];

        // --- 2. AUTHENTICATION ---
        function toggleAuth(view) {
            const login = document.getElementById('login-card');
            const reg = document.getElementById('register-card');
            if(view === 'register') { login.classList.add('hidden'); reg.classList.remove('hidden'); }
            else { reg.classList.add('hidden'); login.classList.remove('hidden'); }
        }

        client.auth.onAuthStateChange((event, session) => {
            if (session) {
                currentUser = session.user;
                initApp();
            } else {
                currentUser = null;
                document.getElementById('auth-container').classList.remove('hidden');
                document.getElementById('app-view').classList.add('hidden');
                document.body.classList.remove('is-admin'); // Limpiar estado al salir
            }
        });

        document.getElementById('form-login').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            Swal.showLoading();
            const { error } = await client.auth.signInWithPassword({ email, password });
            if(error) Swal.fire({ icon: 'error', title: 'Acceso Denegado', text: 'Email o contraseña incorrectos', confirmButtonColor: '#1a4d4f' });
            else Swal.close();
        });

        document.getElementById('form-register').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            if(password.length < 6) return Swal.fire('Contraseña muy corta', 'Mínimo 6 caracteres', 'warning');
            Swal.showLoading();
            const { error } = await client.auth.signUp({ email, password });
            if(error) Swal.fire('Error', error.message, 'error');
            else Swal.fire({ icon: 'success', title: '¡Bienvenido!', text: 'Cuenta creada correctamente.', timer: 1500, showConfirmButton: false });
        });

        async function logout() { await client.auth.signOut(); location.reload(); }

        // --- 3. APP INIT & PROFILE ---
        async function initApp() {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            
            await checkProfile(); // Carga bonos y rol
            cargarHorarios();     // Carga calendario
        }

        async function checkProfile() {
            // Consulta segura a profiles
            const { data, error } = await client.from('profiles').select('rol, bonos').eq('id', currentUser.id).single();
            
            if (error) {
                console.error("Error obteniendo perfil:", error);
                // Si falla (ej. usuario nuevo sin perfil), asumimos user normal
                isAdmin = false;
                document.body.classList.remove('is-admin');
                return;
            }

            if (data) {
                userBonos = data.bonos || 0;
                document.getElementById('bonos-count').textContent = userBonos;
                
                // Configurar modo Admin
                if (data.rol === 'admin') {
                    isAdmin = true;
                    document.body.classList.add('is-admin');
                    // Asegurar que si recarga en usuarios, se vea
                } else {
                    isAdmin = false;
                    document.body.classList.remove('is-admin');
                    // Forzar a vista horarios si estaba en usuarios
                    const vUsuarios = document.getElementById('view-usuarios');
                    if(!vUsuarios.classList.contains('hidden')) switchTab('horarios');
                }

                // Mostrar alerta solo si no tiene bonos y NO es admin
                const alertBox = document.getElementById('no-bonos-alert');
                if (userBonos < 1 && !isAdmin) alertBox.classList.remove('hidden');
                else alertBox.classList.add('hidden');
            }
        }

        // --- 4. HORARIOS (CALENDARIO) ---
        async function cargarHorarios() {
            const container = document.getElementById('schedule-container');
            container.innerHTML = '<div class="flex justify-center py-12"><i class="ph-duotone ph-spinner animate-spin text-4xl text-q19-500"></i></div>';

            const { data: clases } = await client.from('clases').select('*').order('fecha_inicio');
            const { data: reservas } = await client.from('reservas').select('*');

            if (!clases || clases.length === 0) {
                container.innerHTML = '';
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }
            document.getElementById('empty-state').classList.add('hidden');

            const reservasMap = {};
            reservas.forEach(r => {
                if(!reservasMap[r.clase_id]) reservasMap[r.clase_id] = [];
                reservasMap[r.clase_id].push(r);
            });

            // Agrupar por días
            const grupos = {};
            clases.forEach(c => {
                const dateKey = new Date(c.fecha_inicio).toISOString().split('T')[0];
                if (!grupos[dateKey]) grupos[dateKey] = [];
                
                const misRes = reservasMap[c.id] || [];
                c.ocupadas = misRes.length;
                c.miReserva = misRes.find(r => r.user_id === currentUser.id);
                grupos[dateKey].push(c);
            });

            container.innerHTML = '';
            
            // Renderizar Grupos (Días)
            Object.keys(grupos).sort().forEach(dateKey => {
                const dateObj = new Date(dateKey);
                const diaNombre = dateObj.toLocaleDateString('es-ES', { weekday: 'long' });
                const diaNumero = dateObj.getDate();
                const mes = dateObj.toLocaleDateString('es-ES', { month: 'long' });

                const section = document.createElement('div');
                section.className = 'bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden';
                
                section.innerHTML = `
                    <div class="bg-gray-50/50 px-6 py-4 border-b border-gray-100 flex items-baseline gap-2">
                        <span class="brand-font text-2xl font-bold text-gray-900 capitalize">${diaNombre}</span>
                        <span class="text-sm font-medium text-gray-400">${diaNumero} de ${mes}</span>
                    </div>
                    <div id="grid-${dateKey}" class="divide-y divide-gray-50"></div>
                `;
                container.appendChild(section);
                
                const grid = section.querySelector(`#grid-${dateKey}`);

                grupos[dateKey].forEach(c => {
                    const hora = new Date(c.fecha_inicio).toLocaleTimeString('es-ES', {hour:'2-digit', minute:'2-digit'});
                    
                    const isPilates = c.nombre.toLowerCase().includes('pilates');
                    const iconBg = isPilates ? 'bg-rose-50 text-rose-600' : 'bg-teal-50 text-q19-600';
                    const iconName = isPilates ? 'ph-person-simple-run' : 'ph-lotus'; 

                    const llena = c.ocupadas >= c.capacidad_max;
                    const reservada = !!c.miReserva;
                    
                    let btnAction = '';
                    if (reservada) {
                        btnAction = `<button onclick="cancelar(${c.miReserva.id})" class="flex items-center gap-1.5 text-xs font-bold text-gray-400 hover:text-red-600 border border-gray-200 hover:border-red-200 bg-white px-4 py-2 rounded-lg transition"><i class="ph-bold ph-x"></i> CANCELAR</button>`;
                    } else if (llena) {
                        btnAction = `<span class="text-xs font-bold text-gray-300 bg-gray-50 border border-gray-100 px-4 py-2 rounded-lg select-none">COMPLETA</span>`;
                    } else {
                        if (userBonos > 0 || isAdmin) {
                            btnAction = `<button onclick="reservar(${c.id})" class="bg-gray-900 text-white text-xs font-bold px-6 py-2.5 rounded-lg hover:bg-gold-500 hover:shadow-md transition transform active:scale-95">RESERVAR</button>`;
                        } else {
                            btnAction = `<button disabled class="bg-gray-100 text-gray-300 text-xs font-bold px-6 py-2.5 rounded-lg cursor-not-allowed border border-gray-100" title="Sin saldo">0 BONOS</button>`;
                        }
                    }

                    // Botón basura para admin
                    const adminTrash = `<button onclick="borrarClase(${c.id})" class="admin-only hidden text-gray-300 hover:text-red-500 transition p-2" title="Eliminar Clase"><i class="ph-bold ph-trash"></i></button>`;

                    const row = document.createElement('div');
                    row.className = 'p-6 flex flex-col sm:flex-row sm:items-center justify-between gap-4 hover:bg-gray-50/30 transition group';
                    row.innerHTML = `
                        <div class="flex items-center gap-5">
                            <div class="w-16 h-16 rounded-2xl ${iconBg} flex flex-col items-center justify-center flex-shrink-0">
                                <i class="ph-fill ${iconName} text-2xl mb-0.5"></i>
                                <span class="text-[10px] font-black tracking-wide">${hora}</span>
                            </div>
                            <div>
                                <h4 class="brand-font font-bold text-lg text-gray-800 group-hover:text-q19-700 transition flex items-center gap-2">
                                    ${c.nombre}
                                    ${adminTrash}
                                </h4>
                                <div class="flex items-center gap-4 text-sm text-gray-500 mt-1.5">
                                    <div class="flex items-center gap-1.5" title="Aforo">
                                        <i class="ph-fill ph-users text-gray-300"></i>
                                        <span class="font-medium">${c.ocupadas}</span>
                                        <span class="text-gray-300">/ ${c.capacidad_max}</span>
                                    </div>
                                    ${reservada ? '<span class="text-q19-600 bg-q19-50 border border-q19-100 text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wide">Tu Plaza</span>' : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end pt-2 sm:pt-0">${btnAction}</div>
                    `;
                    grid.appendChild(row);
                });
            });
        }

        // --- 5. RESERVAS (RPC) ---
        async function reservar(claseId) {
            // Protección Frontend
            if (userBonos < 1 && !isAdmin) return Swal.fire({ icon:'warning', title:'Sin saldo', text:'Necesitas recargar bonos en Farmacia Q19.', confirmButtonColor: '#2d8a8e' });

            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
            
            // Llamada segura a SQL
            const { error } = await client.rpc('reservar_con_bono', { 
                p_clase_id: claseId, 
                p_user_id: currentUser.id 
            });

            if (error) {
                Swal.fire({ icon:'error', title:'Error', text: error.message });
            } else {
                Toast.fire({ icon: 'success', title: '¡Reserva confirmada!' });
                await checkProfile(); 
                cargarHorarios();
            }
        }

        async function cancelar(reservaId) {
            const res = await Swal.fire({
                title: '¿Cancelar reserva?',
                text: "Se te devolverá 1 bono automáticamente.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#9ca3af',
                confirmButtonText: 'Sí, cancelar'
            });

            if (res.isConfirmed) {
                const { error } = await client.rpc('cancelar_con_bono', { p_reserva_id: reservaId });
                if (error) Swal.fire('Error', error.message, 'error');
                else {
                    Swal.fire({ icon: 'success', title: 'Cancelada', text:'Has recuperado 1 bono.', showConfirmButton: false, timer: 1500 });
                    await checkProfile();
                    cargarHorarios();
                }
            }
        }

        // --- 6. GESTIÓN ADMIN (PESTAÑAS & USUARIOS) ---
        function switchTab(tabName) {
            const tHorarios = document.getElementById('tab-horarios');
            const tUsuarios = document.getElementById('tab-usuarios');
            const vHorarios = document.getElementById('view-horarios');
            const vUsuarios = document.getElementById('view-usuarios');

            if(tabName === 'horarios') {
                vHorarios.classList.remove('hidden');
                vUsuarios.classList.add('hidden');
                tHorarios.classList.add('border-gold-500', 'text-white');
                tHorarios.classList.remove('border-transparent', 'text-gray-400');
                tUsuarios.classList.add('border-transparent', 'text-gray-400');
                tUsuarios.classList.remove('border-gold-500', 'text-white');
            } else {
                vHorarios.classList.add('hidden');
                vUsuarios.classList.remove('hidden');
                tUsuarios.classList.add('border-gold-500', 'text-white');
                tUsuarios.classList.remove('border-transparent', 'text-gray-400');
                tHorarios.classList.add('border-transparent', 'text-gray-400');
                tHorarios.classList.remove('border-gold-500', 'text-white');
                cargarUsuariosAdmin();
            }
        }

        async function cargarUsuariosAdmin() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-400 italic">Cargando base de datos...</td></tr>';

            const { data: users, error } = await client.from('profiles').select('*').order('email');
            
            if (error) return Swal.fire('Error', 'No se pudieron cargar usuarios. Revisa permisos RLS.', 'error');

            allUsersCache = users; 
            renderUsersTable(users);
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('users-table-body');
            const noRes = document.getElementById('no-users-found');
            
            tbody.innerHTML = '';
            
            if(!users || users.length === 0) {
                noRes.classList.remove('hidden');
                return;
            }
            noRes.classList.add('hidden');

            users.forEach(u => {
                const isAdminRow = u.rol === 'admin';
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition group';
                
                const roleBadge = isAdminRow 
                    ? '<span class="bg-gray-900 text-white text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider">Admin</span>' 
                    : '<span class="bg-gray-100 text-gray-500 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider">Cliente</span>';

                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-700 flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center ${isAdminRow ? 'bg-gold-100 text-gold-600' : 'bg-gray-100 text-gray-400'}">
                            <i class="ph-fill ${isAdminRow ? 'ph-crown' : 'ph-user'}"></i>
                        </div>
                        <span class="truncate max-w-[150px] sm:max-w-none">${u.email || 'Sin email'}</span>
                    </td>
                    <td class="px-6 py-4 text-center">${roleBadge}</td>
                    <td class="px-6 py-4 text-center">
                        <span class="font-serif font-bold text-xl ${u.bonos > 0 ? 'text-q19-700' : 'text-gray-300'}">${u.bonos || 0}</span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex justify-end gap-2 opacity-100 sm:opacity-0 group-hover:opacity-100 transition">
                            <button onclick="sumarBono('${u.id}', 1)" class="bg-white border border-gray-200 text-gray-600 hover:text-q19-600 hover:border-q19-300 px-3 py-1.5 rounded-lg text-xs font-bold transition shadow-sm flex items-center gap-1">
                                <i class="ph-bold ph-plus"></i>1
                            </button>
                            <button onclick="sumarBono('${u.id}', 5)" class="bg-gold-500 text-white hover:bg-gold-600 px-3 py-1.5 rounded-lg text-xs font-bold transition shadow-sm flex items-center gap-1">
                                <i class="ph-bold ph-ticket"></i> 5 Pack
                            </button>
                            <button onclick="sumarBono('${u.id}', -1)" class="text-gray-300 hover:text-red-400 px-2 transition" title="Restar bono"><i class="ph-bold ph-minus"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function filtrarUsuarios() {
            const term = document.getElementById('user-search').value.toLowerCase();
            const filtered = allUsersCache.filter(u => u.email && u.email.toLowerCase().includes(term));
            renderUsersTable(filtered);
        }

        async function sumarBono(userId, qty) {
            const { data } = await client.from('profiles').select('bonos').eq('id', userId).single();
            const nuevoSaldo = (data.bonos || 0) + qty;
            
            const { error } = await client.from('profiles').update({ bonos: nuevoSaldo }).eq('id', userId);
            
            if(error) Swal.fire('Error', error.message, 'error');
            else {
                const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 1000});
                Toast.fire({icon: 'success', title: 'Saldo actualizado'});
                cargarUsuariosAdmin();
            }
        }

        // --- 7. GENERAR SEMANA (Admin - CORREGIDO) ---
        async function generarSemana() {
            Swal.fire({ title: 'Generando...', didOpen: () => Swal.showLoading() });
            
            const hoy = new Date();
            const slots = [];
            // Ajustar al lunes
            const diaSemana = hoy.getDay();
            const lunes = new Date(hoy);
            const diff = diaSemana === 0 ? -6 : 1 - diaSemana;
            lunes.setDate(hoy.getDate() + diff);

            for(let i=0; i<5; i++) { // Lu-Vi
               let d = new Date(lunes); d.setDate(lunes.getDate() + i);
               
               // Función helper para calcular fin (ej: 50 minutos de clase)
               const getEnd = (dateObj) => {
                   const fin = new Date(dateObj);
                   fin.setMinutes(fin.getMinutes() + 50); 
                   return fin.toISOString();
               };

               // Mañana 1
               let m1 = new Date(d); m1.setHours(9,30,0,0);
               slots.push({nombre: 'Pilates Reformer', fecha_inicio: m1.toISOString(), fecha_fin: getEnd(m1), capacidad_max: 6});
               
               // Mañana 2
               let m2 = new Date(d); m2.setHours(11,0,0,0);
               slots.push({nombre: 'Yoga Vinyasa Suave', fecha_inicio: m2.toISOString(), fecha_fin: getEnd(m2), capacidad_max: 10});

               // Tarde 1
               let t1 = new Date(d); t1.setHours(18,0,0,0);
               slots.push({nombre: 'Pilates Reformer', fecha_inicio: t1.toISOString(), fecha_fin: getEnd(t1), capacidad_max: 6});
               
               // Tarde 2
               let t2 = new Date(d); t2.setHours(19,30,0,0);
               slots.push({nombre: 'Yoga Hatha Dinámico', fecha_inicio: t2.toISOString(), fecha_fin: getEnd(t2), capacidad_max: 12});
            }
            
            const { error } = await client.from('clases').insert(slots);
            Swal.close();
            
            if(error) Swal.fire('Error', error.message, 'error');
            else {
                Swal.fire({ icon: 'success', title: '¡Semana generada!', showConfirmButton: false, timer: 1500 });
                cargarHorarios();
            }
        }
        
        async function borrarClase(id) {
            const res = await Swal.fire({ title: '¿Borrar clase?', text:'Se cancelarán las reservas.', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33' });
            if(res.isConfirmed) {
                await client.from('clases').delete().eq('id', id);
                cargarHorarios();
            }
        }

        // --- 8. REALTIME ---
        client.channel('public:db').on('postgres_changes', {event: '*', schema: 'public'}, () => {
            checkProfile(); // Escuchar cambios en bonos
            cargarHorarios();
        }).subscribe();
    </script>
</body>
</html>
